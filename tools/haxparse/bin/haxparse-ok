#!/usr/bin/env perl
use v5.36;
use strict;
use warnings;

use FindBin qw($Bin);
use lib "$Bin/../lib";

use Hax::Lexer;
use Hax::Parser;
use Hax::Check::Imports;
use Hax::Check::Unreachable;
use Hax::Check::MustReturn;

sub slurp_utf8 ($path) {
  open(my $fh, '<:encoding(UTF-8)', $path) or die "open $path: $!\n";
  return do { local $/; <$fh> };
}

sub parse_and_check ($path) {
  my $src = slurp_utf8($path);

  my $lex = Hax::Lexer->new(file => $path, src => $src);
  my $p   = Hax::Parser->new(lexer => $lex);
  my $ast = $p->parse;  # dies on syntax error

  my @i = Hax::Check::Imports::check_module($ast);
  if (@i) {
    my $e = $i[0];
    die "$e->{msg} at $e->{file}:$e->{line}:$e->{col}\n";
  }

  my @u = Hax::Check::Unreachable::check_module($ast);
  if (@u) {
    my $e = $u[0];
    die "$e->{msg} at $e->{file}:$e->{line}:$e->{col}\n";
  }

  my @m = Hax::Check::MustReturn::check_module($ast);
  if (@m) {
    my $e = $m[0];
    die "$e->{msg} at $e->{file}:$e->{line}:$e->{col}\n";
  }

  return 1;
}

my $dir = shift(@ARGV) // 'examples/ok';

opendir(my $dh, $dir) or die "opendir $dir: $!\n";
my @files = sort grep { /\.hax\z/ && -f "$dir/$_" } readdir($dh);
closedir($dh);

die "No .hax files found in $dir\n" if !@files;

my ($ok, $bad) = (0, 0);

for my $f (@files) {
  my $path = "$dir/$f";
  eval { parse_and_check($path); 1 } or do {
    chomp(my $err = $@ || "error");
    print "NOT OK  $path\n$err\n";
    $bad++;
    next;
  };
  print "OK      $path\n";
  $ok++;
}

print "\nSummary: OK=$ok  FAIL=$bad\n";
exit($bad ? 1 : 0);
